{% extends 'base.html' %}
{% load static %}

{% block title %}All Pets | PetRescue{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb" class="fade-in">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">All Pets</li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="row">
    <div class="col-12 text-center mb-5 fade-in-up">
      <h1 class="display-4 mb-3">All Pets</h1>
      <p class="lead">Browse all pets that have been accepted in our system. These pets are either lost and looking for their families or found and waiting to be reunited.</p>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <div>
            <h2 class="mb-0">Advanced Search</h2>
            <p class="text-muted small mb-0">Refine your search results</p>
          </div>
          <button class="btn btn-outline-primary d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilterCollapse" aria-expanded="true" aria-controls="advancedFilterCollapse">
            <i class="fas fa-filter"></i>
          </button>
        </div>
        <div class="collapse show" id="advancedFilterCollapse">
          <div class="card-body">
            <form method="GET" id="pet-search-form" class="row g-3">
              <div class="col-md-3">
                <label for="pet_type" class="form-label">Pet Type</label>
                <select name="pet_type" id="pet_type" class="form-select">
                  <option value="">All Pet Types</option>
                  <option value="dog" {% if request.GET.pet_type == 'dog' %}selected{% endif %}>Dog</option>
                  <option value="cat" {% if request.GET.pet_type == 'cat' %}selected{% endif %}>Cat</option>
                  <option value="bird" {% if request.GET.pet_type == 'bird' %}selected{% endif %}>Bird</option>
                  <option value="rabbit" {% if request.GET.pet_type == 'rabbit' %}selected{% endif %}>Rabbit</option>
                  <option value="other" {% if request.GET.pet_type == 'other' %}selected{% endif %}>Other</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label for="breed" class="form-label">Breed</label>
                <input type="text" name="breed" id="breed" class="form-control" placeholder="Breed" value="{{ request.GET.breed }}">
              </div>
              
              <div class="col-md-3">
                <label for="location" class="form-label">Location</label>
                <input type="text" name="location" id="location" class="form-control" placeholder="Location" value="{{ request.GET.location }}">
              </div>
              
              <div class="col-md-3">
                <label for="radius" class="form-label">Radius</label>
                <select name="radius" id="radius" class="form-select">
                  <option value="">Any Distance</option>
                  <option value="5" {% if request.GET.radius == '5' %}selected{% endif %}>5 km</option>
                  <option value="10" {% if request.GET.radius == '10' %}selected{% endif %}>10 km</option>
                  <option value="25" {% if request.GET.radius == '25' %}selected{% endif %}>25 km</option>
                  <option value="50" {% if request.GET.radius == '50' %}selected{% endif %}>50 km</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select name="status" id="status" class="form-select">
                  <option value="">All Statuses</option>
                  <option value="lost" {% if request.GET.status == 'lost' %}selected{% endif %}>Lost</option>
                  <option value="found" {% if request.GET.status == 'found' %}selected{% endif %}>Found</option>
                  <option value="adoptable" {% if request.GET.status == 'adoptable' %}selected{% endif %}>Available for Adoption</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label for="sort" class="form-label">Sort By</label>
                <select name="sort" id="sort" class="form-select">
                  <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest first</option>
                  <option value="oldest" {% if request.GET.sort == 'oldest' %}selected{% endif %}>Oldest first</option>
                  <option value="updated" {% if request.GET.sort == 'updated' %}selected{% endif %}>Most recently updated</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label for="start_date" class="form-label">From Date</label>
                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ request.GET.start_date }}">
              </div>
              
              <div class="col-md-3">
                <label for="end_date" class="form-label">To Date</label>
                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ request.GET.end_date }}">
              </div>
              
              <div class="col-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-1"></i>Search Pets
                  </button>
                  <a href="{% url 'all_pets' %}" class="btn btn-outline-secondary">Reset Filters</a>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Applied Filters Section -->
  {% if request.GET %}
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h3 class="mb-0">Search Results</h3>
      <a href="{% url 'all_pets' %}" class="btn btn-sm btn-outline-secondary">Clear All Filters</a>
    </div>
    <div class="mt-2">
      {% for key, value in request.GET.items %}
        {% if value and key != 'page' %}
          <span class="badge bg-primary me-1 mb-1">
            {{ key|title }}: {{ value }}
            <a href="?{% for k, v in request.GET.items %}{% if k != key %}{{ k }}={{ v }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}" class="text-white ms-1" style="text-decoration: none;">Ã—</a>
          </span>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Loading indicator -->
  <div id="pets-loading" class="text-center py-5 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading pets...</span>
    </div>
    <p class="mt-2">Loading pets...</p>
  </div>

  <!-- Pets Grid -->
  <div class="row g-4" id="pets-container">
    {% if pets %}
      {% for pet in pets %}
        <div class="col-md-6 col-lg-4 fade-in-up pet-card-wrapper" data-status="{{ pet.status }}">
          <div class="card h-100 shadow-sm border-0 rounded-3 pet-card hover-lift">
            {% if pet.image %}
              <img src="{{ pet.image.url }}" class="card-img-top" alt="{{ pet.breed }} - {{ pet.color }} {{ pet.get_pet_type_display }}" style="height: 200px; object-fit: cover;" loading="lazy">
            {% else %}
              <div class="d-flex align-items-center justify-content-center image-placeholder" style="height: 200px;">
                <i class="fas fa-paw fa-3x text-muted"></i>
              </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
              {% if pet.status == 'lost' %}
                <span class="status-badge status-badge-lost align-self-start mb-2">LOST</span>
              {% elif pet.status == 'found' %}
                <span class="status-badge status-badge-found align-self-start mb-2">FOUND</span>
              {% elif pet.status == 'adoptable' %}
                <span class="status-badge status-badge-adoptable align-self-start mb-2">NEEDS HOME</span>
              {% endif %}
              <h5 class="card-title">{{ pet.breed }}</h5>
              <p class="card-text flex-grow-1">
                <strong><i class="fas fa-paw me-1"></i></strong> {{ pet.get_pet_type_display }}<br>
                <strong><i class="fas fa-palette me-1"></i></strong> {{ pet.color }}<br>
                <strong><i class="fas fa-map-marker-alt me-1"></i></strong> {{ pet.location }}<br>
                {% if pet.distance %}
                  <strong><i class="fas fa-road me-1"></i></strong> {{ pet.distance|floatformat:1 }} km<br>
                {% endif %}
                <strong><i class="fas fa-calendar-alt me-1"></i></strong> {{ pet.created_at|date:"M d, Y" }}
              </p>
              <a href="{% url 'pet_detail' pet.id %}?ref=all_pets" class="btn btn-outline-primary mt-auto">
                <i class="fas fa-eye me-1"></i>View Details
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <!-- Fallback content if no pets are available -->
      <div class="col-12 text-center">
        <div class="py-5 fade-in-up">
          <i class="fas fa-paw fa-3x text-muted mb-3"></i>
          <h3 class="mb-3">No Pets Found</h3>
          <p class="lead">There are currently no accepted pets in our system. Check back later!</p>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if pets.has_other_pages %}
  <div class="row mt-5">
    <div class="col-12">
      <nav aria-label="Pet pagination" class="d-flex justify-content-center">
        <ul class="pagination">
          {% if pets.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ pets.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
          {% endif %}
          
          {% for num in pets.paginator.page_range %}
            {% if pets.number == num %}
              <li class="page-item active" aria-current="page">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > pets.number|add:'-3' and num < pets.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if pets.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ pets.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block head_extra %}
<style>
  .breadcrumb {
    background-color: transparent;
    padding: 0;
  }
  
  .filter-btn {
    transition: all 0.3s ease;
  }
  
  .filter-btn.active, .filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .filter-btn.active {
    font-weight: 500;
  }
  
  .pet-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
    /* Add hardware acceleration */
    transform: translateZ(0);
    will-change: transform;
  }
  
  .pet-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
  }
  
  .image-placeholder {
    background-color: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted-text);
    border-radius: var(--border-radius);
  }
  
  @media (max-width: 768px) {
    .filter-btn {
      margin-bottom: 0.5rem;
    }
  }
  
  /* Performance optimization: Optimize all pets page elements */
  .breadcrumb, .filter-btn, .pet-card, .image-placeholder {
    contain: layout style paint;
  }
  
  /* Filter collapse button for mobile */
  @media (max-width: 991.98px) {
    .card-header {
      padding: 1rem !important;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle filter collapse for mobile
    const filterCollapse = document.getElementById('advancedFilterCollapse');
    if (filterCollapse) {
      // On mobile, collapse by default
      if (window.innerWidth < 992) {
        filterCollapse.classList.remove('show');
      }
    }
    
    // Add fade-in animation to pet cards
    const petCardWrappers = document.querySelectorAll('.pet-card-wrapper');
    petCardWrappers.forEach((wrapper, index) => {
      // Add delay for staggered animation
      wrapper.style.animationDelay = (index * 0.1) + 's';
    });
  });
</script>
{% endblock %}