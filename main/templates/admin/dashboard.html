{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<link href="{% static 'css/admin.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}Admin Dashboard | PetRescue{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <h2>Admin Dashboard</h2>
      <p>Welcome, {{ user.username }}! Manage pet report requests efficiently.</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mt-4">
    <div class="col-md-4 mb-4">
      <div class="card stats-card stats-card-warning h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Requests</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_count }} Requests</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-warning"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 mb-4">
      <div class="card stats-card stats-card-success h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Accepted Requests</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">{{ accepted_count }} Requests</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 mb-4">
      <div class="card stats-card stats-card-danger h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Rejected Requests</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">{{ rejected_count }} Requests</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-times-circle fa-2x text-danger"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="row mt-4">
    <div class="col-12">
      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'admin_pending_requests' %}">
            <i class="fas fa-clock"></i> Pending Requests
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'admin_accepted_requests' %}">
            <i class="fas fa-check-circle"></i> Accepted Requests
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'admin_rejected_requests' %}">
            <i class="fas fa-times-circle"></i> Rejected Requests
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'admin_contact_submissions' %}">
            <i class="fas fa-envelope"></i> Contact Submissions
          </a>
        </li>
      </ul>
      
      <div class="tab-content mt-4" id="adminTabContent">
        <!-- Pending Requests Section -->
        <div class="row">
          <div class="col-12">
            <h4 class="mb-4">{{ pending_count }} Requests Pending Review</h4>
          </div>
        </div>
        
        <div class="row">
          {% if recent_pending %}
            {% for req in recent_pending %}
              <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card request-card pending-section h-100 shadow-sm">
                  {% if req.pet.image %}
                    <img src="{{ req.pet.image.url }}" class="card-img-top" alt="Pet Photo" style="height: 200px; object-fit: cover;">
                  {% else %}
                    <div class="d-flex align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa;">
                      <i class="fas fa-paw fa-3x text-muted"></i>
                    </div>
                  {% endif %}
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">
                      {{ req.pet.breed }}
                      <span class="badge badge-pending">Pending</span>
                    </h5>
                    <p class="card-text">
                      <strong>Type:</strong> {{ req.pet.pet_type|title }}<br>
                      <strong>Breed:</strong> {{ req.pet.breed }}<br>
                      <strong>Color:</strong> {{ req.pet.color }}<br>
                      <strong>Location:</strong> {{ req.pet.location }}<br>
                      <strong>Date:</strong> {{ req.created_at|date:"M d, Y" }}<br>
                      <strong>Contact:</strong> {{ req.user.email }}<br>
                      {{ req.phone_number }}
                    </p>
                    <div class="mt-auto">
                      <button class="btn btn-success btn-sm mr-2" data-bs-toggle="modal" data-bs-target="#confirmModal" data-status="accept" data-request-id="{{ req.id }}">
                        <i class="fas fa-check"></i> Accept
                      </button>
                      <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmModal" data-status="reject" data-request-id="{{ req.id }}">
                        <i class="fas fa-times"></i> Reject
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="col-12">
              <div class="alert alert-info">
                <p class="mb-0">No pending requests found.</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Status Change</h5>
        <button type="button" class="close" data-bs-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <span id="action-text">accept</span> this request?</p>
        <p>This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="statusForm" method="POST" style="display: inline;">
          {% csrf_token %}
          <input type="hidden" name="status" id="statusInput" value="">
          <button type="submit" class="btn btn-success" id="confirm-button">Confirm</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Success Message Toast -->
<div class="toast" id="successToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
  <div class="toast-header">
    <strong class="mr-auto">Success</strong>
    <button type="button" class="ml-2 mb-1 close" data-bs-dismiss="toast">
      <span>&times;</span>
    </button>
  </div>
  <div class="toast-body">
    Status updated successfully.
  </div>
</div>

<script>
// Handle modal confirmation
document.addEventListener('DOMContentLoaded', function() {
  var confirmModal = document.getElementById('confirmModal');
  confirmModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var status = button.getAttribute('data-status');
    var requestId = button.getAttribute('data-request-id');
    var modal = this;
    
    // Set the form action URL
    var formAction = "{% url 'update_request_status' 999 %}".replace('999', requestId);
    modal.querySelector('#statusForm').setAttribute('action', formAction);
    
    if (status === 'accept') {
      modal.querySelector('#action-text').textContent = 'accept';
      modal.querySelector('#statusInput').value = 'Accepted';
      modal.querySelector('#confirm-button').classList.remove('btn-danger');
      modal.querySelector('#confirm-button').classList.add('btn-success');
      modal.querySelector('#confirm-button').textContent = 'Accept Request';
    } else {
      modal.querySelector('#action-text').textContent = 'reject';
      modal.querySelector('#statusInput').value = 'Rejected';
      modal.querySelector('#confirm-button').classList.remove('btn-success');
      modal.querySelector('#confirm-button').classList.add('btn-danger');
      modal.querySelector('#confirm-button').textContent = 'Reject Request';
    }
  });
});

// Initialize toasts
document.addEventListener('DOMContentLoaded', function() {
  // This will be replaced with actual message content by Django
  var messageContent = "{{ messages.0 }}" || "";
  if (messageContent) {
    document.querySelector('#successToast .toast-body').textContent = messageContent;
    var toast = new bootstrap.Toast(document.getElementById('successToast'));
    toast.show();
  }
});
</script>
{% endblock %}